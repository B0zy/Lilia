function MODULE:Initialize()
    game.ConsoleCommand("net_maxfilesize 64\n")
    game.ConsoleCommand("sv_kickerrornum 0\n")
    game.ConsoleCommand("sv_allowupload 0\n")
    game.ConsoleCommand("sv_allowdownload 1\n")
    game.ConsoleCommand("sv_allowcslua 0\n")
    game.ConsoleCommand("gmod_physiterations 2\n")
    game.ConsoleCommand("sv_minrate 1048576\n")
end

function MODULE:PlayerSay(client, message)
    local hasIPAddress = string.match(message, "%d+%.%d+%.%d+%.%d+(:%d*)?")
    local hasBadWords = string.find(string.upper(message), string.upper("clone")) and string.find(string.upper(message), string.upper("nutscript"))
    if hasIPAddress then
        ProtectionCore:ApplyPunishment(client, "Typing IP addresses in chat", true, false)
        return ""
    elseif hasBadWords then
        return ""
    end
end

function MODULE:ShouldCollide(ent1, ent2)
    if table.HasValue(ProtectionCore.BlockedCollideEntities, ent1:GetClass()) and table.HasValue(ProtectionCore.BlockedCollideEntities, ent2:GetClass()) then return false end
end

function MODULE:PlayerEnteredVehicle(_, entity)
    if entity:GetClass() == "prop_vehicle_prisoner_pod" then entity:RemoveEFlags(EFL_NO_THINK_FUNCTION) end
end

function MODULE:PlayerLeaveVehicle(_, entity)
    if entity:GetClass() == "prop_vehicle_prisoner_pod" then
        local sName = "PodFix_" .. entity:EntIndex()
        hook.Add("Think", sName, function()
            if entity:IsValid() then
                if entity:GetInternalVariable("m_bEnterAnimOn") then
                    hook.Remove("Think", sName)
                elseif not entity:GetInternalVariable("m_bExitAnimOn") then
                    entity:AddEFlags(EFL_NO_THINK_FUNCTION)
                    hook.Remove("Think", sName)
                end
            else
                hook.Remove("Think", sName)
            end
        end)
    end
end

function MODULE:OnEntityCreated(entity)
    local class = entity:GetClass():lower():Trim()
    if class == "lua_run" then
        function entity:AcceptInput()
            return true
        end

        function entity:RunCode()
            return true
        end

        timer.Simple(0, function() entity:Remove() end)
    elseif class == "point_servercommand" then
        timer.Simple(0, function() entity:Remove() end)
    elseif class == "prop_vehicle_prisoner_pod" then
        entity:AddEFlags(EFL_NO_THINK_FUNCTION)
    end
end

function MODULE:OnPlayerHitGround(client)
    local vel = client:GetVelocity()
    client:SetVelocity(Vector(-(vel.x * 0.45), -(vel.y * 0.45), 0))
end

function MODULE:OnPlayerDropWeapon(_, _, entity)
    local physObject = entity:GetPhysicsObject()
    if physObject then physObject:EnableMotion() end
    timer.Simple(ProtectionCore.TimeUntilDroppedSWEPRemoved, function() if entity and entity:IsValid() then entity:Remove() end end)
end

function MODULE:EntityTakeDamage(entity, dmgInfo)
    local inflictor = dmgInfo:GetInflictor()
    local attacker = dmgInfo:GetAttacker()
    local validClient = IsValid(entity) and entity:IsPlayer()
    local attackerIsHuman = attacker:IsPlayer()
    local notSameAttackerAsEnt = attacker ~= entity
    local isFallDamage = dmgInfo:IsFallDamage()
    local infIsProp = inflictor and IsValid(inflictor) and inflictor:isProp()
    if not (IsValid(attacker) and validClient) or isFallDamage then return end
    if infIsProp then dmgInfo:SetDamage(0) end
    if notSameAttackerAsEnt then
        if attackerIsHuman and attacker:GetNW2Bool("IsActing", false) then return true end
        if ProtectionCore.CharacterSwitchCooldown and (not ProtectionCore.SwitchCooldownOnAllEntities and attackerIsHuman) or ProtectionCore.SwitchCooldownOnAllEntities then entity.LastDamaged = CurTime() end
        if ProtectionCore.CarRagdoll and (IsValid(inflictor) and inflictor:isSimfphysCar()) and not entity:InVehicle() then
            dmgInfo:ScaleDamage(0)
            if not entity:hasRagdoll() then entity:setRagdolled(true, 5) end
        end
    end
end

function MODULE:CanPlayerSwitchChar(client, character)
    if not client:isStaffOnDuty() then
        if ProtectionCore.OnDamageCharacterSwitchCooldown and client.LastDamaged and client.LastDamaged > CurTime() - ProtectionCore.OnDamageCharacterSwitchCooldownTimer then return false, "You took damage too recently to switch characters!" end
        if ProtectionCore.CharacterSwitchCooldown and (character:getData("loginTime", 0) + ProtectionCore.CharacterSwitchCooldownTimer) > os.time() then return false, "You are on cooldown!" end
    end
end